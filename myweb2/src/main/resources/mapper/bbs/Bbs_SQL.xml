<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="bbs">
	<!-- 전체 게시물 레코드 갯수 구하는 쿼리 -->
	<select id="boardListGetCount" parameterType="HashMap" resultType="HashMap">
		SELECT 
			COUNT(IDX) 
		FROM 
			TB_BOARD
	</select>
	
	<!-- 게시물 목록 조회 쿼리 -->
	<select id="selectBoardList" parameterType="HashMap" resultType="HashMap">
		SELECT 
			B.RNUM, 
			B.IDX, 
			B.TITLE, 
			B.HIT_CNT, 
			B.CREA_DTM 
		FROM 
		(
			SELECT 
				ROWNUM AS RNUM, 
				A.IDX, 
				A.TITLE, 
				A.HIT_CNT, 
				A.CREA_DTM 
			FROM 
			(
				SELECT 
					IDX, 
					TITLE, 
					HIT_CNT, 
					CREA_DTM 
				FROM 
					TB_BOARD 
				ORDER BY IDX DESC
			) A 
			WHERE ROWNUM <![CDATA[<=]]> #{END}
		) B 
		WHERE B.RNUM <![CDATA[>=]]> #{START}
	</select>
	
	<!-- 게시물 등록 쿼리 -->
	<insert id="insertBoard" parameterType="HashMap" useGeneratedKeys="true" keyProperty="IDX">
		<selectKey keyProperty="IDX" resultType="String" order="BEFORE">
			SELECT SEQ_TB_BOARD_IDX.NEXTVAL FROM DUAL
		</selectKey>
		INSERT INTO TB_BOARD 
		(
			IDX, 
			TITLE, 
			CONTENTS, 
			HIT_CNT, 
			DEL_GB, 
			CREA_DTM, 
			CREA_ID
		)
		VALUES
		(
			#{IDX},  
			#{TITLE}, 
			#{CONTENTS}, 
			0, 
			'N', 
			SYSDATE, 
			'Admin'
		)
	</insert>
	
	<!-- 게시물 첨부파일 정보 등록 쿼리 -->
	<insert id="insertFile" parameterType="HashMap">
		INSERT INTO TB_FILE 
		(
			IDX, 
			BOARD_IDX, 
			ORIGINAL_FILE_NAME, 
			STORED_FILE_NAME, 
			FILE_SIZE, 
			CREA_ID
		)
		VALUES
		(
			SEQ_TB_FILE_IDX.NEXTVAL, 
			#{BOARD_IDX}, 
			#{ORIGINAL_FILE_NAME}, 
			#{STORED_FILE_NAME}, 
			#{FILE_SIZE}, 
			'Admin'
		)
	</insert>
	
	<!-- 게시물 조회수 증가 쿼리 -->
	<update id="updateHitCnt" parameterType="HashMap">
		UPDATE TB_BOARD 
		SET 
			HIT_CNT = NVL(HIT_CNT, 0) 
		WHERE
			IDX = #{IDX}
	</update>
	
	<!-- 게시물 상세보기 쿼리 -->
	<select id="selectBoardDetail" parameterType="HashMap" resultType="HashMap">
		SELECT 
			IDX, 
			HIT_CNT, 
			CREA_ID, 
			CREA_DTM, 
			TITLE, 
			CONTENTS 
		FROM 
			TB_BOARD 
		WHERE 
			IDX = #{IDX}
	</select>
	
	<!-- 첨부파일 목록보기 쿼리 -->
	<select id="selectFileList" parameterType="HashMap" resultType="HashMap">
		SELECT 
			IDX, 
			ORIGINAL_FILE_NAME, 
			ROUND(FILE_SIZE/1024,1) AS FILE_SIZE 
		FROM 
			TB_FILE 
		WHERE 
			BOARD_IDX = #{IDX} 
			AND DEL_GB = 'N'
	</select>
	
	<!-- 게시물 수정 쿼리 -->
	<update id="boardUpdate" parameterType="HashMap">
		UPDATE TB_BOARD 
		SET 
			TITLE = #{TITLE}, 
			CONTENTS = #{CONTENTS} 
		WHERE 
			IDX = #{IDX}
	</update>
	
	<!-- 첨부파일 삭제 쿼리 -->
	<update id="deleteFileList" parameterType="HashMap">
		UPDATE TB_FILE 
		SET 
			DEL_GB = 'Y' 
		WHERE 
			BOARD_IDX = #{IDX}
	</update>
	
	<!-- 첨부파일 업데이트 쿼리 -->
	<update id="updateFile" parameterType="HashMap">
		UPDATE TB_FIlE 
		SET 
			DEL_GB = 'N' 
		WHERE 
			IDX = #{FILE_IDX}
	</update>
	
	
	<!-- 게시물 삭제 쿼리 -->
	<update id="boardDelete" parameterType="HashMap">
		UPDATE TB_BOARD 
		SET 
			DEL_GB = 'Y' 
		WHERE
			IDX = #{IDX}
	</update>
</mapper>
